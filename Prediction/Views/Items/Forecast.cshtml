@model Prediction.View_Models.ChartN.PricingChart
@{
    ViewData["Title"] = "Forecast";
    @using Prediction.Models.ChartManual
    @using Newtonsoft.Json
    @using Prediction.Models.Chart.Misc;
    var chartItems = Model.DrawChart(Model.SelectedPhones);
    var linePlacement = 48;
}

<h1>Forecast</h1>

<div class="table-wrapper-scroll-y my-custom-scrollbar">
    <form method="post">
        <table class="table table-borderless table-hover table-striped table-sm mb-0">
            <tbody>
                @for (var i = 0; i < Model.Hardware.Count(); i++)
                {
                    <tr>
                        <td>
                            <input type="hidden" asp-for="Hardware[i].ConfigId" />
                            @Model.Hardware[i].ConfigId
                        </td>
                        <td>
                            @Model.Hardware[i].Brand
                        </td>
                        <td>
                            @Model.Hardware[i].Model
                        </td>
                        <td>
                            @if (Model.Hardware[i].isSelected)
                            {
                                <text>
                                    <a asp-action="RemoveFromChart" asp-route-selectedItems="@JsonConvert.SerializeObject(Model.SelectedPhones)" asp-route-currentItem="@JsonConvert.SerializeObject(Model.Hardware[i].ConfigId)">Deselect</a>
                                </text>
                            }
                            else
                            {
                                <text>
                                    <a asp-action="AddToChart" asp-route-selectedItems="@JsonConvert.SerializeObject(Model.SelectedPhones)" asp-route-currentItem="@JsonConvert.SerializeObject(Model.Hardware[i].ConfigId)">Select</a>
                                </text>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

<!-- Displays errors -->
<div class="form-group">
    @Html.Partial("ForecastPartial/_ForecastErrors", Model)
</div>


<div class="box-body">
    <div class="chart-container">
        <canvas id="myChart" style="width:100%; height:400px"></canvas>
    </div>
</div>



<script type="text/javascript">
@if(chartItems.Count() > 0)
{
    <text>
    var originalLineDraw = Chart.controllers.line.prototype.draw;
    Chart.helpers.extend(Chart.controllers.line.prototype, {
        draw: function () {
            originalLineDraw.apply(this, arguments);

            var chart = this.chart;
            var ctx = chart.chart.ctx;

            var index = chart.config.data.lineAtIndex;
            if (index) {
                var xaxis = chart.scales['x-axis-0'];
                var yaxis = chart.scales['y-axis-0'];

                ctx.save();
                ctx.beginPath();
                ctx.moveTo(xaxis.getPixelForValue(undefined, index), yaxis.top);
                ctx.strokeStyle = '#ff0000';
                ctx.lineTo(xaxis.getPixelForValue(undefined, index), yaxis.bottom);
                ctx.stroke();
                ctx.restore();
            }
        }
    });

    var labels =  @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(chartItems[0].LstData.Select(x => x.Date.Month).ToList()));

    var config = {
        type: 'line',
        options: {
            maintainAspectRatio: true,
            responsive: true,
            stacked: false,
            hoverMode: 'index',
        },
        data: {
            labels: labels,
            datasets: [
                @for (int i = 0; i < chartItems.Count(); i++)
                {
                <text>
                {
                    label: "@(chartItems[i].Label)",
                    backgroundColor: ['rgba(@(RGBAColorCollection.Collection[i].R), @(RGBAColorCollection.Collection[i].G), @(RGBAColorCollection.Collection[i].B), 0.1)'],
                    borderColor: ['rgba(@(RGBAColorCollection.Collection[i].R), @(RGBAColorCollection.Collection[i].G), @(RGBAColorCollection.Collection[i].B))'],
                    fill: @(chartItems[i].Fill.ToString().ToLower()),
                    borderWidth: @(chartItems[i].BorderWidth),
                    data: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(chartItems[i].LstData.Select(x => x.Price).ToList())),
                },
                </text>
                }],
            lineAtIndex: @linePlacement
        }
    };

    var ctx = document.getElementById("myChart").getContext("2d");
    new Chart(ctx, config);
    </text>
}
</script>


<style>
    .my-custom-scrollbar {
        position: relative;
        height: 200px;
        overflow: auto;
    }

    .table-wrapper-scroll-y {
        display: block;
    }
</style>